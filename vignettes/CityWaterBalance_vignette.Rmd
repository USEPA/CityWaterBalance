---
title: "Introduction to CityWaterBalance"
author: "Laura Erban"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: readable
    fig_width: 8
    fig_height: 5
vignette: >
  %\VignetteIndexEntry{Introduction to the CityWaterBalance package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

`CityWaterBalance` provides a reproducible workflow for studying urban water
systems.  Any system may be modeled with preassembled data, but data 
for US cities can be gathered via web services using this package and 
dependencies. 


## Install

Development version available on Github:

```{r eval=FALSE}
devtools::install_github("USEPA/CityWaterBalance")
```

```{r}
library("CityWaterBalance")
```

## Usage overview

`CityWaterBalance` is based on a model of the urban water system, shown in the
diagram below.  This diagram specifies the network of water flows along with
a mathematical solution for unknown flows or changes in system storages.  

![](urban_water_system.png)


## Usage examples
There are two ways to run the model in \code{\link{CityWaterBalance}}.

### Option 1:  Input preassembled data

See function inputs for details.  Data should be in
self-consistent units.  Each row of data must represent the same time period.

```{r}
# Specify parameters
p <- list("interc" = 0, "et_mult" = 1, "flow_mult" = 1, "open_wat" = 0.02,
          "run_mult" = 1, "run_css" = 0.35, "bf_mult" = 1, "nonrev" = 0.08,
          "pow_evap" = 0.012, "wast_gen" = 0.85, "pot_atm" = 0.13, 
          "npot_infilt" = 0.5, "slud_evap" = 0, "leak_css" = 0.05, "dgw" = 0.5,
          "dgw_rep" = 0.5)

# Run model
m <- CityWaterBalance(cwb_data,p, print=FALSE)
```

Output from the model includes a list of zoo series with values at each timestep
for the: global flows, internal flows, state variables (storages, producers and 
consumers), internal and global water balances,

```{r}
# Visualize output
plotWaterBalance(m$global_flows)
```

### Option 2: Input data gathered from web services

The CityWaterBalance package has other functions that assemble data for the 
model.  At this time, these functions access US-based web services.

#### Specify spatial and temporal boundaries

Define an area of interest (AOI) and upload that geometry to the 
[USGS Geo Data Portal](https://cida.usgs.gov/gdp/) (GDP). The GDP will give the
geometry a name, which may start wuth 'upload:'.  Here we use a geometry that is 
already available to the GDP in order to automate the example.

```
geometry <- 'sample:Counties'
att <- 'STATE'
val <- 'RI'
area <- 2707
start <- "2015-01-01"
end <- "2015-12-31"
```

#### Get atmospheric data

```
latitude <- 41.5801
atm <- getAtmoFlows(start,end,geometry,att,val,latitude)
```

#### Get streamflow data

Choose streamgages to evaluate total inflow and outflow for the AOI.  
[NWIS mapper](https://maps.waterdata.usgs.gov/) may be useful here.

```
ingages <- c("01112500")
outgages <-c("01113895","01114000","01117000","01118500")

inflow <- getStreamflow(start,end,ingages)
outflow <- getStreamflow(start,end,outgages)
```

Look at the streamflow data with \code{\link{plotStreamflow}}.  Gaps can be 
filled using \code{\link{gapfillStreamflow}}.  When there all time series of 
flows are complete, use \code{\link{combineStreamflow}} (which has an example of 
this process).

#### Get water use data

Identify the states and counties in your AOI. County is the finest spatial scale 
for [USGS water use data](https://waterdata.usgs.gov/nwis/wu) served by NWIS.

```
states <- c("RI")
counties <- list(c("Providence","Kent","Bristol","Newport","Washington"))
wu <- getWaterUse(states,counties,years="ALL")
```

The above retrieves [USGS water use](https://water.usgs.gov/watuse/) data for 
the specified counties for all available years and withdrawal categories. To 
reorganize this output for use by \code{\link{CityWaterBalance}}, use:

```
wu = combineWaterUse(start,end,wu)
```

#### Get other data

Not all requisite data is currently available through web services.  These
inputs (wastewater effluent, sewer overflows, runoff, baseflow and deep 
groundwater recharge) must be gathered from other sources and converted to xts 
objects with the same temporal range and resolution as the other flows. Unit 
must correspond with those specified for inputs to \code{\link{mergeData}}.

Finally, merge the data into a single xts of fluxes (i.e., flow/AOI) for input 
to \code{\link{CityWaterBalance}}.  

```
data <- mergeData(area,atm,inflow,outflow,wu)
```

### Solution

CityWaterBalance solves for the change in storages of all state variables and
cumulatively, the global storage. Uncertainty in the data and parameters creates
a solution space, or range of acceptable solutions according to ancillary
observations of storage changes throughout the system.  The function 
getSolutions



